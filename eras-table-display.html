<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../eras-table/eras-table-column.html'>
<link rel='import' href='../eras-table/eras-table-classes.html'>
<link rel='import' href='../iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../paper-checkbox/paper-checkbox.html'>
<link rel='import' href='../paper-dropdown-menu/paper-dropdown-menu.html'>
<link rel='import' href='../paper-item/paper-item.html'>
<link rel='import' href='../paper-menu/paper-menu.html'>
<link rel='import' href='../paper-icon-button/paper-icon-button.html'>
<link rel='import' href='../paper-material/paper-material.html'>
<link rel='import' href='../paper-progress/paper-progress.html'>
<!--
`eras-table-display` 

### Styling

Property|Description|Default
--------|-----------|-------
`--header-colour`|Colour of the text in the header|`--paper-grey-700`
`--footer-colour`|Colour of the text in the footer|`--paper-grey-700`
`--border-colour`|Colour of the border between rows|`--paper-grey-400`

@demo demo/index.html
-->
<dom-module id='eras-table-display'>
	<template>
		<style include='iron-flex iron-flex-alignment eras-table-classes'>
			:host {
				display: block;
			}

			#toolbar,
			#footer {
				height: 64px;
				padding: 0px 6px 0px 24px;
			}

			#toolbar {
				margin-bottom: 10px;
			}

			#toolbar h1 {
				font-size: 20px;
			}

			#toolbar[selection-type='none'] h1#select-count,
			#toolbar:not([selection-type='none']) h1#header {
				display: none;
			}

			div.table {
				border-collapse: collapse;
				width: 100%;
			}

			div.cell {
				padding: 6px 28px 6px 28px;
				text-align: left;
				border-bottom: 1px solid var(--border-colour, --paper-grey-400);
				font-size: 13px;
			}

			div.cell.selector {
				padding-left: 10px;
				padding-right: 10px;
			}

			div.cell.selector,
			div.cell.selector paper-checkbox {
				width: 18px;
			}

			div.table[select='none'] div.cell.selector,
			div.table[select='single'] div.cell.selector.multi-selector paper-checkbox {
				display: none !important;
			}

			div.cell.head,
			#footer {
				font-size: 12px;
				font-weight: normal;
			}

			div.cell.head {
				color: var(--header-colour, --paper-grey-700);
			}

			#footer {
				height: 56px;
				color: var(--footer-colour, --paper-grey-700);
			}

			div.table[loading] div.cell:not(.head) {
				color: var(--paper-grey-500);
			}

			div.table:not([loading]) #loading paper-progress {
				display: none;
			}

			div.caption#loading {
				height: 4px;
				padding: 0;
				position: relative;
				top: 29px;
			}

			paper-progress {
				width: 100%;
			}

			#perPageMenu {
				margin-right: 20px;
				width: 50px;
				cursor: pointer;
				color: var(--custom-subtitle-colour, --default-subtitle-colour);
				--paper-input-container-underline: {
					display: none;
				}
				--paper-input-container-underline-focus: {
					display: none;
				}
				--paper-input-container-input: {
					text-align: right;
					font-size: 12px;
				}
			}
		</style>
		<slot name=''></slot>
		<paper-material elevation='1'>
			<div id='toolbar' class='layout horizontal center'>
				<h1 id='header'>{{heading}}</h1>
				<h1 id="select-count">{{selectedIds.length}} Items Selected</h1>
				<div class="flex"></div>
				<div id="single-select-actions">
					<slot name="single-select-actions"></slot>
				</div>
				<div id="multi-select-actions">
					<slot name="multi-select-actions"></slot>
				</div>
				<div id='search'>
					<paper-icon-button icon="swap-vert" on-tap="_showSort"></paper-icon-button>
					<paper-icon-button icon="search" on-tap="_showFilter"></paper-icon-button>
				</div>
			</div>
			<div class='table' loading$='{{loading}}' select$='{{select}}'>
				<div id='loading' class='caption'>
					<paper-progress indeterminate></paper-progress>
				</div>
				<div id='head' class='header'>
					<div class='row'>
						<div class='cell selector multi-selector'>
							<paper-checkbox noink on-iron-change='_doMultiSelect'></paper-check-box>
						</div>
						<template is='dom-repeat' items='{{columns}}' as='column'>
							<div class='cell head label'>{{column.label}}</div>
						</template>
					</div>
				</div>
				<div id='body' class='body'>
					<template is='dom-repeat' items='{{data}}' as='row' on-dom-change='_rowsChanged'>
						<div class='row data'>
							<div class='cell selector'>
								<paper-checkbox noink checked$='{{_isSelected(row)}}' value='{{_getId(row)}}' on-iron-change='_doSingleSelect'></paper-checkbox>
							</div>
							<template is='dom-repeat' items='{{columns}}' as='column'>
								<div class='cell'>{{getData(column, row)}}</div>
							</template>
						</div>
					</template>
				</div>
			</div>
			<div id='footer' class='layout horizontal center'>
				<div class='flex'></div>
				<div>Rows:</div>
				<div>
					<paper-dropdown-menu id='perPageMenu' no-label-float on-iron-select='_changePerPage' vertical-align='bottom'>
						<paper-menu class='dropdown-content' selected='{{page.size}}' attr-for-selected='value'>
							<template is='dom-repeat' items='{{_pageSizeOptions}}' as='option'>
								<paper-item value='{{option}}'>{{option}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
				</div>
				<div>{{_pagingInfo.from}}-{{_pagingInfo.to}} of {{page.results}}</div>
				<template is='dom-repeat' items='{{_pagingButtons}}' as='button'>
					<paper-icon-button id='{{button.id}}' icon='{{button.icon}}' on-tap='_goToPage' data-target-page='{{button.target}}' disabled$='{{!button.enabled}}'></paper-icon-button>
				</template>
			</div>
		</paper-material>
	</template>

	<script>
		Polymer({
			is: 'eras-table-display',
			properties: {
				/**
				 * Text to be displayed above the table
				 * @type String
				 */
				heading: String,

				/**
					* Array of `eras-table-column` elements describing the columns to be used for the table.
					* It should be filled during initialisation with `eras-table-column`s found in the 'columns' slot
					* @type {eras-table-column[]} 
					*/
				columns: {
					type: Array,
					value: []
				},

				/**
					* Array of objects containing the current page of data to display in the table.
					* Each object in the array represents a row in the table where the name of the properties
					* are matched by the value of the `property` properties of the `columns` objects, and the
					* values are the data to be displayed.
					* @type {Object[]}
					*/
				data: {
					type: Array,
					value: []
				},

				/**
				 * Specifies whether to display the loading UI (show the loading bar and grey out table contents).
				 * @type {Boolean}
				 */
				loading: {
					type: Boolean,
					value: false,
					observer: '_loadingChanged'
				},

				/**
				 * Object containing data needed for pagination UI.
				 * - `current`: The current page number
				 * - `size`: The number of results to display per page
				 * - `results`: The total number of results
				 * @type {{ current:Number, size:Number, results:Number }}
				 */
				page: {
					type: Object,
					value: { current: 1, size: 10, results: 0 }
				},

				/**
				 * Name of the property that can be used to uniquely identify
				 * each row of data.
				 */
				idProperty: String,

				/**
				 * Array of currently selected ids.
				 * @type {String[]}
				 */
				selectedIds: {
					type: Array,
					value: [],
					notify: true
				},

				/**
				 * The type of row selection to use. Allowed values are: 
				 * - `none` 
				 * - `single`
				 * - `multi`
				 * @type {String}
				 */
				select: {
					type: String,
					value: 'none',
					observer: '_selectChanged'
				},

				/**
				 * Object containing information for pagination UI display. 
				 * Is computed using the `page` property
				 * @type {{ from:Number, to:Number }}
				 */
				_pagingInfo: {
					type: Object,
					value: { from: 0, to: 0 },
					computed: '_computePagingInfo(page)'
				},

				/**
				 * Objects defining the properties of the pagination buttons.				
				 * @type {{ id:String, icon:String, target:Number, enabled: Boolean }[]}
				 */
				_pagingButtons: {
					type: Array,
					computed: '_computePagingButtons(page)'
				},

				/**
				 * An array of available page size options
				 * @type {Number[]}
				 */
				_pageSizeOptions: {
					type: Array,
					computed: '_computePageSizeOptions(page)'
				},

				/**
				 * Boolean specifying whether or not to react changes events
				 * fired by the checkboxes for individual rows. Especially 
				 * useful for ignoring events while setting up tests.
				 */
				_listenForSingleSelect: {
					type: Boolean,
					value: false
				},

				/**
				 * Boolean specifying whether or not to react changes events
				 * fired by the multi select checkbox. Especially 
				 * useful for ignoring events while setting up tests.
				 */
				_listenForMultiSelect: {
					type: Boolean,
					value: false
				}
			},

			ready: function () {
				this._observer = Polymer.dom(this).observeNodes(function (i) {
					this.columns = i.addedNodes.filter(function (n) { return n.tagName === 'ERAS-TABLE-COLUMN'; });
				});
			},

			/**
				* Gets the data for a given column from the supplied row and formats it for display.				
				* @param {Object} column Object from the `columns` property that represents the column to get the data for
				* @param {Object} row Object from the `data` property that contains the data to be displayed
				* @return {String} The data from the given row/column formatted using the `format` Function of the column
				*/
			getData: function (column, row) {
				return column.formatData(row[column.property]);
			},

			/**
			 * Gets the value of the id property from the supplied row, identified by `idProperty`.
			 * @param {Object} row Object from the `data` property
			 * @return {String} Value for the id property from the supplied row.
			 */
			_getId: function (row) {
				return row[this.idProperty];
			},

			/**
			 * Computes the object containing information for pagination UI display.			
			 * @param {Object} page Object from the `page` property
			 * @return {{ from:Number, to:Number }}
			 */
			_computePagingInfo: function (page) {
				var from = (this.page.current - 1) * this.page.size + 1;
				var to = Math.min(from + this.page.size - 1, page.results);

				return {
					from: from,
					to: to
				};
			},

			/**
			 * Computes the array of objects that are iterated over to produce the pagination buttons.			
			 * @param {Object} page Object from the `page` property
			 * @return {{ id:String, icon: String, target:Number, enabled:Boolean }[]}
			 */
			_computePagingButtons: function (page) {
				var last = Math.ceil(page.results / page.size);
				var arr = [];

				arr[0] = {
					id: 'first',
					icon: 'first-page',
					target: 1,
					enabled: page.current > 1
				};

				arr[1] = {
					id: 'previous',
					icon: 'chevron-left',
					target: Math.max(page.current - 1, 1),
					enabled: page.current > 1
				};

				arr[2] = {
					id: 'next',
					icon: 'chevron-right',
					target: Math.min(page.current + 1, last),
					enabled: page.current < last
				};

				arr[3] = {
					id: 'last',
					icon: 'last-page',
					target: last,
					enabled: page.current < last
				};

				return arr;
			},

			/**
			 * Computes the options for page size that will be shown on the dropdown
			 */
			_computePageSizeOptions: function (page) {
				return [5, 10, 25, 50, 100, page.results]
					.filter(function (value, index, self) {
						return value <= page.results && self.indexOf(value) === index;
					});
			},

			/**
			 * Function called when the dom-repeat has finished rendering the 
			 * rows fo data
			 */
			_rowsChanged: function () {
				this._listenForMultiSelect = true;
				this._listenForSingleSelect = true;
			},

			/**
			 * Function for the pagination buttons to call 'on-tap'. 
			 * checks if the button is disabled (because even when disabled the
			 * `tap` event can be triggered by calling `.click()`) then fires
			 * a `change-page` event.			
			 * @return {{ target:Number }}
			 */
			_goToPage: function (e) {
				var button = Polymer.dom(e).localTarget;

				if (!button.disabled)
					this.fire('change-page', { target: button.dataTargetPage });
			},

			/**
			 * Function to be called when a new page size is selected.
			 * Fires a `change-per-page` event with the requested page size.			
			 * @return {{ size:Number }}
			 */
			_changePerPage: function (e) {
				this.fire('change-per-page', { size: e.detail.item.value });
			},

			/**
			 * When the `loading` property is changed this function updates the
			 * position of the loading indicator. `top: 29px` is set in style but
			 * if a label wraps it may be more than this
			 */
			_loadingChanged: function (newValue, oldValue) {
				if (oldValue === undefined)
					return;

				var loading = this.$.loading;
				var heading = this.$.head;
				loading.style.top = (loading.offsetHeight + heading.offsetHeight - 1) + 'px';
			},

			/**
			 * Observer function to monitor the select property.
			 * If the specified value is not one of the accepted values then
			 * it will print a warning to the console and default to `none`
			 */
			_selectChanged: function (select) {
				var accepted = ['none', 'single', 'multi'];
				if (accepted.indexOf(select) < 0) {
					console.warn('"' + select + '" is not a valid value for select-type. Defaulting to "none". Valid values are: ' + accepted);
					this.select = 'none';
				}
			},

			/**
			 * Checks the property specified by `idProperty` to see if it
			 * is in the `selectedIds`.
			 */
			_isSelected: function (row) {
				var id = row[this.idProperty];
				return this.selectedIds.indexOf(id) >= 0;
			},

			/**
			 * Adds or removes the id for all visible rows from `selectedIds`, and 
			 * ensures the correct checkboxes are ticked. 
			 * Listening to change events for single and multi select is turned off for 
			 * the duration of this call.
			 * Fires `selection-change` when finished
			 * @return {{selectedIds:Number[]}
			 */
			_doMultiSelect: function (e) {
				if (!this._listenForMultiSelect)
					return;

				this._listenForSingleSelect = false;
				this._listenForMultiSelect = false;

				var checked = e.target.checked;
				var checkboxes = this.$.body.querySelectorAll('div.cell.selector paper-checkbox');

				for (var i = 0; i < checkboxes.length; i++) {
					var id = checkboxes[i].value;
					var selected = this.selectedIds.indexOf(id) >= 0;

					if (checked)
						Polymer.dom(checkboxes[i]).setAttribute('checked', '');
					else
						Polymer.dom(checkboxes[i]).removeAttribute('checked');

					if (checked && !selected)
						this.push('selectedIds', id);

					if (!checked && selected)
						this.splice('selectedIds', this.selectedIds.indexOf(id), 1);
				}

				this._listenForSingleSelect = true;
				this._listenForMultiSelect = true;

				this.fire('selection-change', { selectedIds: this.selectedIds });
			},

			/**
			 * Adds or removes the id for a specific row from `selectedIds` when the associated
			 * check box is clicked, and ensures the correct checkboxes are ticked. 
			 * Listening to change events for single and multi select is turned off for 
			 * the duration of this call.
			 * Fires `selection-change` when finished
			 * @return {{selectedIds:Number[]}
			 */
			_doSingleSelect: function (e) {
				if (!this._listenForSingleSelect)
					return;

				this._listenForSingleSelect = false;
				this._listenForMultiSelect = false;

				var checked = e.target.checked;
				var id = e.target.value;

				// if this id is already selected remove it regardless
				if (this.selectedIds.indexOf(id) >= 0)
					this.splice('selectedIds', this.selectedIds.indexOf(id), 1);

				// if select type is single
				// clear the selected ids list and uncheck all checkboxes
				if (this.select == 'single' && checked) {
					this.selectedIds = [];
					var checkboxes = this.$.body.querySelectorAll('div.cell.selector paper-checkbox');
					for (var i = 0; i < checkboxes.length; i++)
						Polymer.dom(checkboxes[i]).removeAttribute('checked');
				}

				// put the id in the selected ids array and check this checkbox
				if (checked) {
					this.push('selectedIds', id);
					Polymer.dom(e.target).setAttribute('checked');
				}

				// check/uncheck multiselect checkbox depending on current selection
				if (this.select == 'multi') {
					var unchecked = this.$.body.querySelectorAll('div.cell.selector paper-checkbox:not([checked])');
					var multi = Polymer.dom(this.$.head.querySelector('div.cell.selector.multi-selector paper-checkbox'));

					if (unchecked.length > 0)
						multi.removeAttribute('checked');
					else
						multi.setAttribute('checked', '');
				}

				this._listenForSingleSelect = true;
				this._listenForMultiSelect = true;

				this.fire('selection-change', { selectedIds: this.selectedIds });
			}
		});
	</script>
</dom-module>