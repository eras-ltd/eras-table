<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../eras-table/eras-table-column.html'>
<link rel='import' href='../eras-table/eras-table-classes.html'>
<link rel='import' href='../iron-flex-layout/iron-flex-layout-classes.html'>
<link rel='import' href='../paper-dropdown-menu/paper-dropdown-menu.html'>
<link rel='import' href='../paper-item/paper-item.html'>
<link rel='import' href='../paper-menu/paper-menu.html'>
<link rel='import' href='../paper-icon-button/paper-icon-button.html'>
<link rel='import' href='../paper-material/paper-material.html'>
<link rel='import' href='../paper-progress/paper-progress.html'>
<!--
`eras-table-display` 

### Styling

Property|Description|Default
--------|-----------|-------
`--header-colour`|Colour of the text in the header|`--paper-grey-700`
`--footer-colour`|Colour of the text in the footer|`--paper-grey-700`
`--border-colour`|Colour of the border between rows|`--paper-grey-400`

@demo demo/index.html
-->
<dom-module id='eras-table-display'>
	<template>
		<style include='iron-flex iron-flex-alignment eras-table-classes'>
			:host {
				display: block;
			}

			#main-toolbar,
			#footer {
				height: 64px;
				padding: 0px 6px 0px 24px;
			}

			div.table {
				border-collapse: collapse;
				width: 100%;
			}

			div.cell {
				padding: 6px 28px 6px 28px;
				text-align: left;
			}

			div.cell {
				border-bottom: 1px solid var(--border-colour, --paper-grey-400);
				font-size: 13px;
			}

			div.cell.head,
			#footer {
				font-size: 12px;
				font-weight: normal;
			}

			div.cell.head {
				color: var(--header-colour, --paper-grey-700);
			}

			#footer {
				height: 56px;
				color: var(--footer-colour, --paper-grey-700);
			}

			div.table[loading] div.cell:not(.head) {
				color: var(--paper-grey-500);
			}

			div.table:not([loading]) #loading paper-progress {
				display: none;
			}

			div.caption#loading {
				height: 4px;
				padding: 0;
				position: relative;
				top: 29px;
			}

			paper-progress {
				width: 100%;
			}

			#perPageMenu {
				margin-right: 20px;
				width: 50px;
				cursor: pointer;
				color: var(--custom-subtitle-colour, --default-subtitle-colour);
				--paper-input-container-underline: {
					display: none;
				}
				--paper-input-container-underline-focus: {
					display: none;
				}
				--paper-input-container-input: {
					text-align: right;
					font-size: 12px;
				}
			}
		</style>
		<slot name=''></slot>
		<paper-material elevation='1'>
			<div class='table' loading$='{{loading}}'>
				<div id='loading' class='caption'>
					<paper-progress indeterminate></paper-progress>
				</div>
				<div id='head' class='header'>
					<div class='row'>
						<template is='dom-repeat' items='{{columns}}' as='column'>
							<div class='cell head label'>{{column.label}}</div>
						</template>
					</div>
				</div>
				<div id='body' class='body'>
					<template is='dom-repeat' items='{{data}}' as='row'>
						<div class='row data'>
							<template is='dom-repeat' items='{{columns}}' as='column'>
								<div class='cell'>{{getData(column, row)}}</div>
							</template>
						</div>
					</template>
				</div>
			</div>
			<div id='footer' class='layout horizontal center'>
				<div class='flex'></div>
				<div>Rows:</div>
				<div>
					<paper-dropdown-menu id='perPageMenu' no-label-float on-iron-select='_changePerPage' vertical-align='bottom'>
						<paper-menu class='dropdown-content' selected='{{page.size}}' attr-for-selected='value'>
							<template is='dom-repeat' items='{{_pageSizeOptions}}' as='option'>
								<paper-item value='{{option}}'>{{option}}</paper-item>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
				</div>
				<div>{{_pagingInfo.from}}-{{_pagingInfo.to}} of {{page.results}}</div>
				<template is='dom-repeat' items='{{_pagingButtons}}' as='button'>
					<paper-icon-button id='{{button.id}}' icon='{{button.icon}}' on-tap='_goToPage' data-target-page='{{button.target}}' disabled$='{{!button.enabled}}'></paper-icon-button>
				</template>
			</div>
		</paper-material>
	</template>

	<script>
		Polymer({
			is: 'eras-table-display',
			properties: {
				/**
					* Array of `eras-table-column` elements describing the columns to be used for the table.
					* It should be filled during initialisation with `eras-table-column`s found in the 'columns' slot
					* @type {eras-table-column[]} 
					*/
				columns: {
					type: Array,
					value: []
				},

				/**
					* Array of objects containing the current page of data to display in the table.
					* Each object in the array represents a row in the table where the name of the properties
					* are matched by the value of the `property` properties of the `columns` objects, and the
					* values are the data to be displayed.
					* @type {Object[]}
					*/
				data: {
					type: Array,
					value: []
				},

				/**
				 * Specifies whether to display the loading UI (show the loading bar and grey out table contents).
				 * @type {Boolean}
				 */
				loading: {
					type: Boolean,
					value: false,
					observer: '_loadingChanged'
				},

				/**
				 * Object containing data needed for pagination UI.
				 * - `current`: The current page number
				 * - `size`: The number of results to display per page
				 * - `results`: The total number of results
				 * @type {{ current:Number, size:Number, results:Number }}
				 */
				page: {
					type: Object,
					value: { current: 1, size: 10, results: 0 }
				},

				/**
				 * Name of the property that can be used to uniquely identify
				 * each row of data.
				 */
				idProperty: String,

				/**
				 * The type of row selection to use. Allowed values are: 
				 * - `none` 
				 * - `single`
				 * - `multi`
				 * @type {String}
				 */
				selectType: {
					type: String,
					value: 'none',
					observer: '_selectTypeChanged'
				},

				/**
				 * Object containing information for pagination UI display. 
				 * Is computed using the `page` property
				 * @type {{ from:Number, to:Number }}
				 */
				_pagingInfo: {
					type: Object,
					value: { from: 0, to: 0 },
					computed: '_computePagingInfo(page)'
				},

				/**
				 * Objects defining the properties of the pagination buttons.				
				 * @type {{ id:String, icon:String, target:Number, enabled: Boolean }[]}
				 */
				_pagingButtons: {
					type: Array,
					computed: '_computePagingButtons(page)'
				},

				/**
				 * An array of available page size options
				 * @type {Number[]}
				 */
				_pageSizeOptions: {
					type: Array,
					computed: '_computePageSizeOptions(page)'
				},
			},

			ready: function () {
				this._observer = Polymer.dom(this).observeNodes(function (i) {
					this.columns = i.addedNodes.filter(function (n) { return n.tagName === 'ERAS-TABLE-COLUMN'; });
				});
			},

			/**
				* Gets the data for a given column from the supplied row and formats it for display.				
				* @param {Object} column Object from the `columns` property that represents the column to get the data for
				* @param {Object} row Object from the `data` property that contains the data to be displayed
				* @return {String} The data from the given row/column formatted using the `format` Function of the column
				*/
			getData: function (column, row) {
				return column.formatData(row[column.property]);
			},

			/**
			 * Computes the object containing information for pagination UI display.			
			 * @param {Object} page Object from the `page` property
			 * @return {{ from:Number, to:Number }}
			 */
			_computePagingInfo: function (page) {
				var from = (this.page.current - 1) * this.page.size + 1;
				var to = Math.min(from + this.page.size - 1, page.results);

				return {
					from: from,
					to: to
				};
			},

			/**
			 * Computes the array of objects that are iterated over to produce the pagination buttons.			
			 * @param {Object} page Object from the `page` property
			 * @return {{ id:String, icon: String, target:Number, enabled:Boolean }[]}
			 */
			_computePagingButtons: function (page) {
				var last = Math.ceil(page.results / page.size);
				var arr = [];

				arr[0] = {
					id: 'first',
					icon: 'first-page',
					target: 1,
					enabled: page.current > 1
				};

				arr[1] = {
					id: 'previous',
					icon: 'chevron-left',
					target: Math.max(page.current - 1, 1),
					enabled: page.current > 1
				};

				arr[2] = {
					id: 'next',
					icon: 'chevron-right',
					target: Math.min(page.current + 1, last),
					enabled: page.current < last
				};

				arr[3] = {
					id: 'last',
					icon: 'last-page',
					target: last,
					enabled: page.current < last
				};

				return arr;
			},

			/**
			 * Computes the options for page size that will be shown on the dropdown
			 */
			_computePageSizeOptions: function (page) {
				return [5, 10, 25, 50, 100, page.results]
					.filter(function (value, index, self) {
						return value <= page.results && self.indexOf(value) === index;
					});
			},

			/**
			 * Function for the pagination buttons to call 'on-tap'. 
			 * checks if the button is disabled (because even when disabled the
			 * `tap` event can be triggered by calling `.click()`) then fires
			 * a `change-page` event.			
			 * @return {{ target:Number }}
			 */
			_goToPage: function (e) {
				var button = Polymer.dom(e).localTarget;

				if (!button.disabled)
					this.fire('change-page', { target: button.dataTargetPage });
			},

			/**
			 * Function to be called when a new page size is selected.
			 * Fires a `change-per-page` event with the requested page size.			
			 * @return {{ size:Number }}
			 */
			_changePerPage: function (e) {
				this.fire('change-per-page', { size: e.detail.item.value });
			},

			/**
			 * When the `loading` property is changed this function updates the
			 * position of the loading indicator. `top: 29px` is set in style but
			 * if a label wraps it may be more than this
			 */
			_loadingChanged: function (newValue, oldValue) {
				if (oldValue === undefined)
					return;

				var loading = this.$.loading;
				var heading = this.$.head;
				loading.style.top = (loading.offsetHeight + heading.offsetHeight - 1) + 'px';
			},

			/**
			 * Observer function to monitor the selectType property.
			 * If the specified value is not one of the accepted values then
			 * it will print a warning to the console and default to `none`
			 */
			_selectTypeChanged: function(selectType) {
				var accepted = ['none','single','multi'];
				if(accepted.indexOf(selectType) < 0) {
					console.warn('"' + selectType + '" is not a valid value for select-type. Defaulting to "none". Valid values are: ' + accepted);
					this.selectType = 'none';
				}
			}
		});
	</script>
</dom-module>