<!doctype html>
<html lang='en'>

<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes'>

	<title>eras-table test</title>

	<script src='../../webcomponentsjs/webcomponents-lite.js'></script>
	<script src='../../web-component-tester/browser.js'></script>

	<link rel='import' href='../eras-table-display.html'>
</head>

<body>
	<template is='dom-bind' id='basic-table'>
		<eras-table-display id='basic-fixture' data='{{data}}' page='{{page}}' id-property='prop-1'>
			<eras-table-column property='prop-1' label='Column 1'></eras-table-column>
			<eras-table-column property='prop-2' label='Column 2'></eras-table-column>
			<eras-table-column property='prop-3' label='Column 3'></eras-table-column>
		</eras-table-display>
	</template>
	<script>
		var table = document.querySelector('#basic-table');
		table.data = [];

		for (var row = 0; row < 3; row++) {
			table.data[row] = {};
			for (var col = 1; col <= 3; col++) {
				table.data[row]['prop-' + col] = 'data-' + row + '-prop-' + col;
			}
		}

		table.page = { current: 1, size: 5, results: 12 };
	</script>

	<script>
		suite('eras-table-display', function () {
			suite('basic', function () {
				var el;

				setup(function () {
					el = document.querySelector('#basic-fixture');
				});

				test('instantiation', function (done) {
					assert.equal(el.is, 'eras-table-display');
					done();
				});

				test('select type', function (done) {
					// temporarily disable console.warn so the message about invalid values
					// doesn't show up in the console (test failures are errors so should be OK)
					var w = console.warn;
					console.warn= function(){};
					el.selectType = 'xxx';
					console.warn = w;					
					assert.equal(el.selectType, 'none');
					done();
				});

				test('columns', function (done) {
					flush(function () {
						var cols = el.$.head.querySelectorAll('div.cell.head.label');
						assert.equal(el.columns.length, 3, 'table.columns should have 3 objects but has ' + el.columns.length);
						assert.equal(cols.length, 3, 'the table should have 3 column labels (th.label) but has ' + cols.length);
						done();
					});
				});

				test('rows', function (done) {
					flush(function () {
						var rows = el.$.body.querySelectorAll('div.row.data');
						assert.equal(el.data.length, 3, 'table.data should have 3 objects but has ' + el.data.length);
						assert.equal(rows.length, 3, 'the table should have 3 data rows (tr.data) but has ' + rows.length);
						done();
					});
				});

				test('get data', function (done) {
					flush(function () {
						var col = el.columns[1];
						var row = el.data[2];
						var x = el.getData(col, row);
						assert.equal(x, 'data-2-prop-2');
						done();
					});
				});

				suite('paging buttons', function () {
					var lastPage;
					var params = [];

					params[0] = { page: 1, buttons: [] };
					params[0].buttons[0] = { id: 'first', index: 0, target: 1, enabled: false };
					params[0].buttons[1] = { id: 'previous', index: 1, target: 1, enabled: false };
					params[0].buttons[2] = { id: 'next', index: 2, target: 2, enabled: true };
					params[0].buttons[3] = { id: 'last', index: 3, target: 3, enabled: true };

					params[1] = { page: 2, buttons: [] };
					params[1].buttons[0] = { id: 'first', index: 0, target: 1, enabled: true };
					params[1].buttons[1] = { id: 'previous', index: 1, target: 1, enabled: true };
					params[1].buttons[2] = { id: 'next', index: 2, target: 3, enabled: true };
					params[1].buttons[3] = { id: 'last', index: 3, target: 3, enabled: true };

					params[2] = { page: 3, buttons: [] };
					params[2].buttons[0] = { id: 'first', index: 0, target: 1, enabled: true };
					params[2].buttons[1] = { id: 'previous', index: 1, target: 2, enabled: true };
					params[2].buttons[2] = { id: 'next', index: 2, target: 3, enabled: false };
					params[2].buttons[3] = { id: 'last', index: 3, target: 3, enabled: false };

					setup(function () {
						lastPage = Math.ceil(el.page.results / el.page.size);
					});

					suite('objects', function () {
						for (var p = 0; p < params.length; p++) {
							var param = params[p];

							for (var b = 0; b < param.buttons.length; b++) {
								var button = param.buttons[b];

								test('page ' + param.page + ': ' + button.id, function (done) {
									el.page = { current: param.page, size: el.page.size, results: el.page.results };
									flush(function () {
										var buttonElement = el._pagingButtons[button.index];
										assert.equal(buttonElement.target, button.target, 'on page ' + param.page + ' ' + button.id + '.target should be ' + button.target);
										assert.equal(buttonElement.enabled, button.enabled, 'on page ' + param.page + ' ' + button.id + '.enabled should be ' + button.enabled);
										done();
									});
								});
							}
						}
					});

					suite('elements', function () {
						for (var p = 0; p < params.length; p++) {
							var param = params[p];

							for (var b = 0; b < param.buttons.length; b++) {
								var button = param.buttons[b];

								test('page ' + param.page + ': ' + button.id, function (done) {
									el.page = { current: param.page, size: el.page.size, results: el.page.results };
									flush(function () {
										var buttonElement = el.$$('#' + button.id);
										assert.equal(buttonElement.dataTargetPage, button.target, 'on page ' + param.page + ' ' + button.id + '.dataTargetPage should be ' + button.target);
										assert.equal(buttonElement.disabled, !button.enabled, 'on page ' + param.page + ' ' + button.id + '.disabled should be ' + (!button.enabled));
										done();
									});
								});
							}
						}
					});

					suite('events', function () {
						var spy;

						setup(function () {
							spy = sinon.spy(el, 'fire');
						});

						teardown(function () {
							el.fire.restore();
						});

						for (var p = 0; p < params.length; p++) {
							var param = params[p];

							for (var b = 0; b < param.buttons.length; b++) {
								var button = param.buttons[b];

								test('page ' + param.page + ': ' + button.id, function (done) {
									el.page = { current: param.page, size: el.page.size, results: el.page.results };
									flush(function () {
										el.$$('#' + button.id).click();

										if (button.enabled) {
											assert(spy.withArgs('change-page').calledOnce, 'change-page event should have fired once');
											assert(spy.withArgs('change-page', { target: button.target }).calledOnce, 'change-page event fired but with wrong args: ' + JSON.stringify(spy.args));
										} else {
											assert(spy.withArgs('change-page').notCalled, 'change-page event should not have fired');
										}
										done();
									});
								});
							}
						}
					});
				});

				suite('page size', function () {
					var menu;

					setup(function () {
						menu = el.$.perPageMenu;
					});

					test('setup', function (done) {
						flush(function () {
							assert.equal(menu.is, 'paper-dropdown-menu');
							done();
						});
					});

					var params = [];
					params[0] = { results: 0, options: [] };
					params[1] = { results: 3, options: [3] };
					params[2] = { results: 5, options: [5] };
					params[3] = { results: 6, options: [5, 6] };
					params[4] = { results: 11, options: [5, 10, 11] };
					params[5] = { results: 25, options: [5, 10, 25] };
					params[6] = { results: 100, options: [5, 10, 25, 50, 100] };
					params[7] = { results: 101, options: [5, 10, 25, 50, 100, 101] };
					params[8] = { results: 9999, options: [5, 10, 25, 50, 100, 9999] };

					suite('objects', function () {
						for (var i = 0; i < params.length; i++) {
							var p = params[i];

							test('with ' + p.results + ' results', function (done) {
								el.page = { current: el.page.current, size: el.page.current, results: p.results };
								flush(function () {
									var biggest = Math.max.apply(null, el._pageSizeOptions);
									assert.equal(biggest, p.results, 'expected the biggest page size (' + biggest + ') to == the number of results (' + el.page.results + ')');
									assert.deepEqual(el._pageSizeOptions, p.options, 'expected ' + p.options + ' options for page size but there were ' + el._pageSizeOptions)
									done();
								});
							});
						}
					});

					suite('elements', function () {
						for (var i = 0; i < params.length; i++) {
							var p = params[i];

							test('with ' + p.results + ' results', function (done) {
								el.page = { current: el.page.current, size: el.page.current, results: p.results };
								flush(function () {																
									// get list of page size options from value attr of paper-item elements
									var elements = menu.querySelectorAll('paper-item');
									var options = [];
									for (var j = 0; j < elements.length; j++)
										options[j] = elements[j].value;
									
									var biggest = Math.max.apply(null, options);
									assert.equal(biggest, p.results, 'expected the biggest page size (' + biggest + ') to == the number of results (' + el.page.results + ')');
									assert.deepEqual(options, p.options, 'expected ' + p.options + ' options for page size but there were ' + options)
									done();
								});
							});
						}
					});

					suite('events', function () {
						var spy;
						var options = [5, 10, 25, 30];

						suiteSetup(function () {							
							el.page = { current: el.page.current, size: el.page.current, results: Math.max.apply(null, options) };
						});

						setup(function(){
							spy = sinon.spy(el, 'fire');
						});

						teardown(function () {
							el.fire.restore();
						});

						// this method of looping tests was inspired by this answer:
						// https://stackoverflow.com/a/17316273/723645 
						var dataTest = function (index, option) {
							return function (done) {
								flush(function () {
									var button = menu.querySelectorAll("paper-item")[index];
									button.click();
									assert(spy.withArgs('change-per-page').calledOnce, 'change-per-page event should have fired once');
									assert(spy.withArgs('change-per-page', { size: option }).calledOnce, 'change-per-page event fired but with wrong args: ' + JSON.stringify(spy.args));
									done();
								});
							};
						};

						for (var i = 0; i < options.length; i++) {
							var option = options[i];
							test(option + ' per page', dataTest(i, option));
						}
					});
				});
			});
		});
	</script>
</body>

</html>